---
title: "The influence of weather and a pandemic on crime"
output:
  html_document:
    df_print: paged
---
```{r Markdown cheatsheet, echo=FALSE}
# echo=FALSE prevents code, but not the results from appearing in the rendered file
# eval=TRUE evaluates the code and includes the results
# results='hide' hides the results but displays the code
```


### Install packages (if required)

```{r install packages, eval=FALSE} 
# set eval=TRUE if running script for the first time
# install.packages("bigrquery")
# install.packages("devtools") 
# devtools::install_github("rstats-db/bigrquery", force = TRUE)
```

### Load packages (each session)

```{r eval=TRUE, results='hide'}
library(bigrquery)
library(ggplot2)
library(tidyr)
library(dplyr)
library(lubridate) # handle date information
library(readr) # read txt file with credentials
```

### Retrieve Google Cloud credentials
Retrieve Google Cloud project ID, which I store in an external file (not uploaded to github).
```{r set up credentials, }
# Set Google Cloud project ID here
project_name <- read_file("./GC_credentials.txt")
```

### Generate a table with counts by year and offence
 The statement needs to be written in Standard SQL. 
 More info in the [BigQuery documentation](cloud.google.com/bigquery/docs/reference/standard-sql/) 

```{r setup request}
sql <- "
SELECT 
  iucr,
  primary_type,
  description, 
  year, 
  COUNT(*) AS counts
FROM `bigquery-public-data.chicago_crime.crime` 
GROUP BY 
  iucr,
  primary_type,
  description,
  year
 ORDER BY year ASC;
"
```

```{r execute SQL call}
# Execute the query and store the result
counts_year <- query_exec(sql, project = project_name, use_legacy_sql = FALSE)
```
```{r}
str(counts_year)
```


```{r}
# order by highest offence counts (over all years)
head(counts_year[order(counts_year$counts, decreasing = TRUE),])
```
```{r Display in wide format}
counts_wide <- counts_year %>% spread(year, counts, fill = NA, convert = FALSE)
# display ordered by highest counts in 2020
head(counts_wide[order(counts_wide$`2020`, decreasing=TRUE),])
```

### How much data do we have?

```{r}
sql <- "SELECT COUNT(*)
FROM `bigquery-public-data.chicago_crime.crime`;"
```

```{r execute SQL call}
# Execute the query and store the result
counts <- query_exec(sql, project = project_name, use_legacy_sql = FALSE, max_pages = Inf)
counts
```


## Pull in date information for more granular time series analysis

```{r setup request}
sql <- "
SELECT 
  iucr,
  primary_type,
  description, 
  date
FROM `bigquery-public-data.chicago_crime.crime` 
"
```

```{r execute SQL call}
# Execute the query and store the result
counts_day <- query_exec(sql, project = project_name, use_legacy_sql = FALSE, max_pages = Inf)
str(counts_day)
```

```{r}
head(counts_day)
counts_day_copy <- counts_day
```


```{r tease out date information into separate columns}
# generating the columns removes the need to create them ad hoc in every calculation below
counts_day_parts <- counts_day %>% 
  mutate(date = as.Date(date, format = "%m/%d/%y")) %>%
  mutate(year = format(date, "%y"))  %>%
  mutate(month = format(date, "%m")) %>%
  mutate(day = format(date, "%d"))
str(counts_day_parts)
```


```{r}
# bar chart with counts for every day --> seasonality
ggplot(counts_day_parts) + aes(x = date) + 
  geom_bar()
```


```{r calculate the sum offense counts for each month per year}
counts_day_parts$iucr <- factor(counts_day_parts$iucr)
counts_day_parts$year <- as.integer(counts_day_parts$year)
counts_day_parts$month <- as.integer(counts_day_parts$month)
counts_day_parts$day <- as.integer(counts_day_parts$day)

# specify package of function as there are naming conflicts
per_month <- counts_day_parts %>% 
  group_by(year, month) %>% 
  dplyr::summarise(counts = dplyr::n())

head(per_month)
```

### plot monthly totals over years
```{r}
years <- format(seq(as.Date("2001/1/1"), by = "year", length.out = 20), "%Y")
per_month %>%
  # second month as date for axis
  mutate(month2 = as.Date(paste0("2015-", month,"-01"),"%Y-%m-%d")) %>%
  # second year as date for grouping
  mutate(year2 = as.Date(paste0(year),"%y")) %>%
  ggplot() + 
  aes(x = month2, y = counts, color = factor(year2)) +
  geom_line() +
  labs(title = "Montly Counts of Offenses in Chicago",
           subtitle = "Data plotted by year",
           y = "Counts of monthly offenses",
           x = "Month") + 
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom") +
  scale_color_discrete(name="Year", labels = years) +
  # format x labels
  scale_x_date(date_labels = "%b", date_breaks = "2 months") +
  # start plot at zero
  scale_y_continuous(limits = c(0, 50000))
```


