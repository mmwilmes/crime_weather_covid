---
title: "TimeSeriesDecomposition"
author: "Madlen Wilmes"
date: "6/1/2020"
output: html_document
---

```{r Markdown cheatsheet, echo=FALSE}
# echo=FALSE prevents code, but not the results from appearing in the rendered file
# eval=TRUE evaluates the code and includes the results
# results='hide' hides the results but displays the code
```


### Install packages (if required)

```{r install packages, eval=FALSE, message=FALSE, warning=FALSE} 
# set eval=TRUE if running script for the first time
if(!require("ggseas")) install.packages("ggseas")
if(!require("forecast")) install.packages("forecast")
if(!require("data.table")) install.packages("data.table")
if(!require("knitr")) install.packages("knitr")
if(!require("bigrquery")) install.packages("bigrquery")
if(!require("devtools")) install.packages("devtools") 
if(!require("tsibble")) install.packages("tsibble")
if(!require("fable")) install.packages("fable")  # forecasting package of the tidyverse family
# devtools::install_github("rstats-db/bigrquery", force = TRUE)
```

### Load packages

```{r eval=TRUE, message=FALSE, warning=FALSE}
library(bigrquery)
library(ggplot2)
library(tidyr)
library(dplyr)
library(lubridate) # handle date information
library(readr) # read txt file with credentials
library(fable)
library(tsibble)
library(feasts)
library(ggpmisc) # plot R^2 in scatter plot
```

## TODO --> source the ReadData or read the csv

```{r read in data from csv}
counts_day <- read.csv("crime_weather_day.csv")
head(counts_day)
# format as date
counts_day$date <- as.Date(counts_day$date)
head(counts_day)
```

### Time Series Decomposition

```{r STL decomposition}
dcmp <- daily_crime %>%
    index_by(year_month = ~ yearmonth(.)) %>% # monthly aggregates
    summarise(
      avg_counts = mean(counts, na.rm = TRUE)
    ) %>%
  model(STL(avg_counts))
components(dcmp)
```

```{r autoplot including trend line}
daily_counts %>%
  index_by(year_month = ~ yearmonth(.)) %>% # monthly aggregates
    summarise(
      avg_counts = mean(counts, na.rm = TRUE)
    ) %>%
  autoplot(avg_counts, color='gray') +
  autolayer(components(dcmp), trend, color='red') +
  xlab("Year") + ylab("Avg. daily offense counts") +
  ggtitle("Daily avg offense counts per month and overall trend.")
```
The trend-cycle component (red) and the raw data (grey).


We can plot all of the components in a single figure using autoplot():

```{r visually parse out components}
components(dcmp) %>% autoplot() + xlab("Year")
```

The grey bars to the left of each panel show the relative scales of the components. Each grey bar represents the same length but because the plots are on different scales, the bars vary in size.

We are not interested to understand seasonal changes in offense counts, so let's plot the trend again, but adjust for seasonal effects (i.e., remove seasonal effects). In other words, seasonally adjusted time series contain the remainder component as well as the trend-cycle (but not the seasonal compotent).

## Seasonal adjustment of offense counts
```{r seasonal adjustment}
daily_counts %>%
  index_by(year_month = ~ yearmonth(.)) %>% # monthly aggregates
    summarise(
      avg_counts = mean(counts, na.rm = TRUE)
    ) %>%
  autoplot(avg_counts, color='gray') +
  autolayer(components(dcmp), season_adjust, color='blue') +
  xlab("Year") + ylab("Avg. daily offense counts") +
  ggtitle("Seasonally adjusted offense counts")
```
